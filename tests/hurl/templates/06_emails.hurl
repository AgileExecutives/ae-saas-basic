# Email API Tests with Unique Data
# Tests email sending, management, and querying endpoints

# First, create a test user and get authentication token
POST {{HOST}}/api/v1/auth/register
Content-Type: application/json
{
  "username": "{{UNIQUE_USERNAME}}",
  "email": "{{UNIQUE_EMAIL}}",
  "password": "{{UNIQUE_PASSWORD}}",
  "first_name": "Email",
  "last_name": "Tester",
  "tenant_id": 1
}

# Accept either success or conflict (user exists)
HTTP *

# Now login to get the token regardless of registration result
POST {{HOST}}/api/v1/auth/login
Content-Type: application/json
{
  "username": "{{UNIQUE_USERNAME}}",
  "password": "{{UNIQUE_PASSWORD}}"
}

HTTP 200
[Captures]
auth_token: jsonpath "$.data.token"

# Test 1: Send an email
POST {{HOST}}/api/v1/emails/send
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "to": "{{UNIQUE_EMAIL}}",
  "from": "sender_{{UNIQUE_ID}}@example.com",
  "subject": "Test Email Subject - {{UNIQUE_ID}}",
  "body": "This is a test email body for {{UNIQUE_ID}}.",
  "html_body": "<h1>Test Email {{UNIQUE_ID}}</h1><p>This is a test email body in <strong>HTML</strong>.</p>"
}

# Email creation may have database issues, accept various status codes
HTTP *
[Asserts]
jsonpath "$.success" exists

# Test 2: Get all emails
GET {{HOST}}/api/v1/emails
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data.data" exists

# Test 3: Get email by ID (use a test ID)
GET {{HOST}}/api/v1/emails/1
Authorization: Bearer {{auth_token}}

# Accept either success or not found
HTTP *
[Asserts]
jsonpath "$.success" exists

# Test 4: Search emails by subject
GET {{HOST}}/api/v1/emails?search={{UNIQUE_ID}}
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data.data" isCollection

# Test 5: Filter emails by recipient (may not be implemented)
GET {{HOST}}/api/v1/emails?to={{UNIQUE_EMAIL}}
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data.data" isCollection

# Test 6: Get email statistics
GET {{HOST}}/api/v1/emails/stats
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data.total" exists
jsonpath "$.data.pending" exists

# Test 7: Try to access emails without authentication
GET {{HOST}}/api/v1/emails

HTTP 401
[Asserts]
jsonpath "$.success" == false

# Test 8: Send email with invalid data
POST {{HOST}}/api/v1/emails/send
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "to": "invalid-email",
  "subject": "Test"
}

HTTP 400
[Asserts]
jsonpath "$.success" == false