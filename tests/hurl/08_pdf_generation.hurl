# PDF Generation Tests
# Test PDF generation endpoints including template listing, PDF generation, and streaming

# Setup authentication for PDF tests
POST {{host}}/api/v1/auth/login
Content-Type: application/json
{
  "username": "testuser",
  "password": "newpass123"
}

HTTP 200
[Captures]
auth_token: jsonpath "$.data.token"
user_tenant_id: jsonpath "$.data.user.tenant_id"

# Test getting PDF configuration
GET {{host}}/api/v1/pdf/config
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data.template_dir" isString
jsonpath "$.data.output_dir" isString
jsonpath "$.data.page_size" isString
jsonpath "$.data.orientation" isString

# Test listing available PDF templates
GET {{host}}/api/v1/pdf/templates
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data" isCollection
jsonpath "$.message" contains "templates"

# Test getting specific template information (using invoice template)
GET {{host}}/api/v1/pdf/templates/invoice
Authorization: Bearer {{auth_token}}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data.template" == "invoice"
jsonpath "$.data.available" == true

# Test template preview with sample data
POST {{host}}/api/v1/pdf/templates/invoice/preview
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "data": {
    "InvoiceNumber": "TEST-001",
    "InvoiceDate": "2024-01-15",
    "Company": {
      "Name": "Test Company Ltd",
      "Address": "123 Business Street",
      "City": "Test City",
      "Country": "Test Country",
      "Phone": "+1-555-0123",
      "Email": "billing@testcompany.com"
    },
    "Customer": {
      "Name": "John Doe",
      "Email": "john@example.com",
      "Address": "456 Customer Ave",
      "City": "Customer City"
    },
    "Items": [
      {
        "Description": "Professional Services",
        "Quantity": 2,
        "UnitPrice": 150.00,
        "Total": 300.00
      },
      {
        "Description": "Consultation",
        "Quantity": 1,
        "UnitPrice": 200.00,
        "Total": 200.00
      }
    ],
    "Subtotal": 500.00,
    "Tax": 50.00,
    "Total": 550.00,
    "Currency": "USD",
    "DueDate": "2024-02-15",
    "Notes": "Payment due within 30 days"
  }
}

HTTP 200
[Asserts]
jsonpath "$.success" == true
jsonpath "$.data" contains "DOCTYPE html"
header "Content-Type" contains "text/html"

# Test PDF generation from template
POST {{host}}/api/v1/pdf/generate
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "template": "invoice",
  "data": {
    "InvoiceNumber": "HURL-TEST-001",
    "InvoiceDate": "2024-01-15",
    "Company": {
      "Name": "AE SaaS Test Company",
      "Address": "123 Test Street",
      "City": "Test City",
      "Country": "Test Country",
      "Phone": "+1-555-TEST",
      "Email": "test@ae-saas.com"
    },
    "Customer": {
      "Name": "Test Customer",
      "Email": "customer@test.com",
      "Address": "789 Customer Lane"
    },
    "Items": [
      {
        "Description": "Test Service",
        "Quantity": 1,
        "UnitPrice": 100.00,
        "Total": 100.00
      }
    ],
    "Subtotal": 100.00,
    "Tax": 10.00,
    "Total": 110.00,
    "Currency": "USD",
    "DueDate": "2024-02-15"
  },
  "config": {
    "page_size": "A4",
    "orientation": "Portrait",
    "margin_top": "1cm",
    "margin_bottom": "1cm",
    "margin_left": "1cm",
    "margin_right": "1cm"
  }
}

HTTP 200
[Asserts]
jsonpath "$.success" == true
header "Content-Type" == "application/pdf"
header "Content-Disposition" contains "attachment"
header "Content-Disposition" contains "invoice"

# Test PDF generation from raw HTML
POST {{host}}/api/v1/pdf/generate/html
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "html": "<!DOCTYPE html><html><head><title>Test Report</title><style>body{font-family:Arial,sans-serif;margin:40px;}.header{border-bottom:2px solid #333;padding-bottom:10px;}.content{margin-top:20px;}.footer{margin-top:40px;border-top:1px solid #ccc;padding-top:10px;font-size:12px;color:#666;}</style></head><body><div class='header'><h1>Test Report</h1><p>Generated: {{.GeneratedDate}}</p></div><div class='content'><h2>Report Summary</h2><p>This is a test PDF generated from raw HTML content.</p><ul><li>Item 1: Test data</li><li>Item 2: More test data</li><li>Item 3: Additional information</li></ul></div><div class='footer'><p>Generated by AE SaaS Basic PDF System</p></div></body></html>",
  "data": {
    "GeneratedDate": "January 15, 2024"
  },
  "config": {
    "page_size": "A4",
    "orientation": "Portrait",
    "quality": 90
  }
}

HTTP 200
[Asserts]
jsonpath "$.success" == true
header "Content-Type" == "application/pdf"
header "Content-Disposition" contains "attachment"

# Test PDF streaming for large documents
POST {{host}}/api/v1/pdf/generate/stream
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "template": "report",
  "data": {
    "ReportTitle": "Large Test Report",
    "GeneratedDate": "2024-01-15",
    "Items": []
  },
  "config": {
    "page_size": "A4",
    "orientation": "Portrait"
  }
}

HTTP 200
[Asserts]
header "Content-Type" == "application/pdf"
header "Transfer-Encoding" contains "chunked"

# Test PDF generation with invalid template
POST {{host}}/api/v1/pdf/generate
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "template": "nonexistent_template",
  "data": {}
}

HTTP 400
[Asserts]
jsonpath "$.success" == false
jsonpath "$.error" contains "template"

# Test PDF generation with missing required data
POST {{host}}/api/v1/pdf/generate
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "template": "invoice"
}

HTTP 400
[Asserts]
jsonpath "$.success" == false
jsonpath "$.error" contains "data"

# Test PDF generation with invalid HTML
POST {{host}}/api/v1/pdf/generate/html
Authorization: Bearer {{auth_token}}
Content-Type: application/json
{
  "html": "<invalid-html-content"
}

HTTP 400
[Asserts]
jsonpath "$.success" == false
jsonpath "$.error" contains "HTML"

# Test PDF generation without authentication
POST {{host}}/api/v1/pdf/generate
Content-Type: application/json
{
  "template": "invoice",
  "data": {"test": "data"}
}

HTTP 401
[Asserts]
jsonpath "$.success" == false
jsonpath "$.error" contains "authorization"

# Test getting template info for non-existent template
GET {{host}}/api/v1/pdf/templates/nonexistent
Authorization: Bearer {{auth_token}}

HTTP 404
[Asserts]
jsonpath "$.success" == false
jsonpath "$.error" contains "not found"

# Test configuration endpoint accessibility
GET {{host}}/api/v1/pdf/config

HTTP 401
[Asserts]
jsonpath "$.success" == false
jsonpath "$.error" contains "authorization"